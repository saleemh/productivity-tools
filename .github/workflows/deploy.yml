name: Deploy

on:
  push:
    branches: ["main", "master"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build site
        run: |
          mkdocs build --strict

      - name: Prepare SSH key
        env:
          SSH_KEY: ${{ secrets.SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "$SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy via rsync
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_TARGET_DIR: ${{ secrets.SSH_TARGET_DIR }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          PORT_OPT=""
          if [ -n "$SSH_PORT" ]; then PORT_OPT="-p $SSH_PORT"; fi
          RSYNC_RSH="ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=yes $PORT_OPT"
          rsync -az --delete -e "$RSYNC_RSH" --rsync-path="mkdir -p $SSH_TARGET_DIR && rsync" site/ "$SSH_USER@$SSH_HOST:$SSH_TARGET_DIR"
